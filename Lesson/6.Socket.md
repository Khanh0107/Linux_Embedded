# Socket

---

## 1. Overview 

Sockets are communication mechanisms that allow processes to communicate with each other whether the processes are on the same device or different devices.

A socket is represented by a socket descriptor file.

The information described in a socket file will include: Domain, Type, Protocol.

```c
int socket(int domain, int type, int protocol);
```

---

## 1.1 Domain

Domain (or address family) specifies what kind of addresses your socket will use — for example, IP addresses or UNIX file paths.

Socket has 2 main domains:
- Internet Domain: Sockets operate on the Internet Domain if the sending and receiving processes are on different hosts.
- UNIX Domain: Sockets operate on the UNIX Domain if the sending and receiving processes are on the same host.

**Common value**

| Constant    | Description                       | Use Case                    |
| ----------- | --------------------------------- | --------------------------- |
| `AF_INET`   | IPv4 Internet protocols           | TCP/UDP over IPv4           |
| `AF_INET6`  | IPv6 Internet protocols           | TCP/UDP over IPv6           |
| `AF_UNIX`   | UNIX domain sockets (file-based)  | IPC between local processes |
| `AF_PACKET` | Raw access to the data link layer | Sniffing Ethernet packets   |


`AF_ stands` for Address Family — often used interchangeably with domain.

## 1.2 Type

The `type` defines how data is transmitted — whether it's a reliable stream, a packet, etc.

Sockets have two common types: stream and datagram

| Stream Socket                                                                 | Datagram Socket                                                                 |
|-------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| Reliable (data is received in order, with error notification if issues occur) | Unreliable (data may arrive out of order, be lost, and no error is notified)    |
| Requires a connection before data exchange                                    | No connection is required; data can be sent even if the destination doesn't exist |
| Commonly used when data is a stream of bits                                   | Commonly used when data is sent as individual packets                            |


**Common value**

| Constant         | Description                                         | Protocol Used |
| ---------------- | --------------------------------------------------- | ------------- |
| `SOCK_STREAM`    | Reliable, connection-based, byte stream             | TCP           |
| `SOCK_DGRAM`     | Unreliable, connectionless, datagram                | UDP           |
| `SOCK_RAW`       | Direct IP packet access                             | Custom / ICMP |
| `SOCK_SEQPACKET` | Like `SOCK_STREAM` but preserves message boundaries | SCTP          |
| `SOCK_RDM`       | Reliable datagram, not widely supported             | Rare          |

## 1.3 Protocol

This defines the **specific protocol** used in conjunction with the domain and type. Usually set to 0 to select the **default protocol** for the given domain & type.


# 2. Flow operation

---

## 2.1 Flow operation of stream socket


A stream socket `(SOCK_STREAM)` provides a reliable, connection-oriented communication channel between two endpoints — like a phone call between client and server.

The process that initiates the connection acts as the client, and the process that receives the connection request is the server.

**Server step**

```c
int sockfd = socket(AF_INET, SOCK_STREAM, 0); // Step 1
bind(sockfd, ...);                            // Step 2
listen(sockfd, ...);                          // Step 3
int clientfd = accept(sockfd, ...);           // Step 4
recv(clientfd, ...);                          // Step 5
send(clientfd, ...);                          // Step 6
close(clientfd);                              // Step 7
close(sockfd);                                // Step 8
```

| Step | Function          | Purpose                                                                 |
| ---- | ----------------- | ----------------------------------------------------------------------- |
| 1    | `socket()`        | Create a socket descriptor                                              |
| 2    | `bind()`          | Bind socket to an IP address and port number                            |
| 3    | `listen()`        | Put the socket into passive mode to accept connections                  |
| 4    | `accept()`        | Block and wait for a client to connect; returns a new socket descriptor |
| 5    | `recv()`          | Receive data from the client                                            |
| 6    | `send()`          | Send data to the client                                                 |
| 7    | `close(clientfd)` | Close the connection with that specific client                          |
| 8    | `close(sockfd)`   | Close the main listening socket when done                               |

**Client steps**

```c
int sockfd = socket(AF_INET, SOCK_STREAM, 0); // Step 1
bind(sockfd, ...);                            // Step 2
listen(sockfd, ...);                          // Step 3
int clientfd = accept(sockfd, ...);           // Step 4
recv(clientfd, ...);                          // Step 5
send(clientfd, ...);                          // Step 6
close(clientfd);                              // Step 7
close(sockfd);                                // Step 8
```

| Step | Function          | Purpose                                                                 |
| ---- | ----------------- | ----------------------------------------------------------------------- |
| 1    | `socket()`        | Create a socket descriptor                                              |
| 2    | `bind()`          | Bind socket to an IP address and port number                            |
| 3    | `listen()`        | Put the socket into passive mode to accept connections                  |
| 4    | `accept()`        | Block and wait for a client to connect; returns a new socket descriptor |
| 5    | `recv()`          | Receive data from the client                                            |
| 6    | `send()`          | Send data to the client                                                 |
| 7    | `close(clientfd)` | Close the connection with that specific client                          |
| 8    | `close(sockfd)`   | Close the main listening socket when done                               |

## 2.2 Flow operation of Datagram Socket

In Datagram sockets, the roles of client and server are quite vague.

Basically, processes can send data to an address regardless of whether that address exists or not.

In the transmission and reception process, we temporarily consider the process that wants to send data as the client and the process that receives data as the server.

**Characteristic**

- Connectionless: No handshake; data is sent directly (do not require a connection to be established with `connect()`)
- Unreliable: No guarantee of delivery, ordering, or duplication prevention.
- Message-Oriented: Data is sent and received in discrete packets.
- Used when speed is more important than reliability (e.g., DNS, VoIP, video streaming).

**Server steps**

```c
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);        // Step 1
bind(sockfd, ...);                                  // Step 2
recvfrom(sockfd, buffer, ..., &client_addr, ...);   // Step 3
sendto(sockfd, buffer, ..., &client_addr, ...);     // Step 4
close(sockfd);                                      // Step 5
```

```sh
| Step | Function     | Description                                                        |
| ---- | ------------ | ------------------------------------------------------------------ |
| 1    | `socket()`   | Create a datagram socket                                           |
| 2    | `bind()`     | Bind the socket to an IP and port                                  |
| 3    | `recvfrom()` | Wait for a datagram from any client (doesn't require connection)   |
| 4    | `sendto()`   | Send a response back to the client using the received address info |
| 5    | `close()`    | Close the socket when done                                         |
```

**Client step**

```c
int sockfd = socket(AF_INET, SOCK_DGRAM, 0);        // Step 1
sendto(sockfd, buffer, ..., &server_addr, ...);     // Step 2
recvfrom(sockfd, buffer, ..., &server_addr, ...);   // Step 3 (optional)
close(sockfd);                                      // Step 4
```

| Step | Function     | Description                                            |
| ---- | ------------ | ------------------------------------------------------ |
| 1    | `socket()`   | Create a datagram socket                               |
| 2    | `sendto()`   | Send a datagram to the server                          |
| 3    | `recvfrom()` | (Optional) Wait for a response (if the server replies) |
| 4    | `close()`    | Close the socket                                       |

